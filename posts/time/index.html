<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " vocab="http://ogp.me/ns" lang="en">
<head>
<!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-158200162-1"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-158200162-1');
    </script><meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>Time | Xdev</title>
<link href="../../assets/css/rst.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/code.css" rel="stylesheet" type="text/css">
<link rel="stylesheet" type="text/css" href="../../assets/css/main.css">
<link rel="stylesheet" type="text/css" href="../../assets/css/icons.css">
<link href="https://fonts.googleapis.com/css?family=Audiowide%7CCrimson+Pro%7CMerriweather%7CSaira+Stencil+One&amp;display=swap" rel="stylesheet">
<link rel="apple-touch-icon" sizes="180x180" href="../../assets/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="../../assets/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="../../assets/img/favicon-16x16.png">
<link rel="manifest" href="../../assets/site.webmanifest">
<link href="../../assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/ipython.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#1A658F">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../rss.xml">
<link rel="canonical" href="https://ncar.github.io/xdev/posts/time/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Julia Kent">
<link rel="next" href="../we-are-xdev/" title="We are Xdev!" type="text/html">
<meta property="og:site_name" content="Xdev">
<meta property="og:title" content="Time">
<meta property="og:url" content="https://ncar.github.io/xdev/posts/time/">
<meta property="og:description" content="The Significance of Time¶






Time is relative, as my coworker Anderson likes to remind me every time manipulating this coordinate proves to be relatively difficult.







This post is to be the fi">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2019-08-28T13:45:45-06:00">
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@NCARXdev">
</head>
<body>
  <div class="site-wrapper" style="background: #FFF">

    
    <header class="site-header outer"><div class="inner">
        
    <nav class="site-nav" style="top: 0;"><div class="site-nav-menu">
        <ul class="nav" role="menu">
<li class="nav-item" role="menuitem"><a class="nav-logo" href="../../"><img src="../../assets/img/xdev_logo.png" alt="Xdev"></a></li>
          
        <li class="nav-item" role="menuitem"><a class="nav-link" href="../../pages/about/">About</a></li>
        <li class="nav-item" role="menuitem"><a class="nav-link" href="../../rss.xml">RSS</a></li>
        <li class="nav-item" role="menuitem"><a class="nav-link" href="../../pages/status/">Dashboard</a></li>

          

        </ul>
</div>
      <div class="site-nav-social">
        <a href="https://github.com/NCAR/xdev" class="social-link" target="_blank"><span class="icon-github"></span></a>
        <a href="https://twitter.com/NCARXdev" class="social-link" target="_blank"><span class="icon-twitter"></span></a>
      </div>
    </nav>
</div>
    </header><main class="site-main outer" role="main"><div class="inner">
        

    <article class="post-full"><header class="post-full-header"><h1 class="post-full-title">Time</h1>
        <section class="post-meta"><time class="post-meta-date" datetime="2019-08-28T13:45:45-06:00">
            2019 August 28
          </time><span class="post-meta-divider">|</span>
          <a href="../../authors/julia-kent/">Julia Kent</a>
        </section></header><section class="post-full-content"><div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="The-Significance-of-Time">The Significance of Time<a class="anchor-link" href="#The-Significance-of-Time">¶</a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Time is relative, as my coworker Anderson likes to remind me every time manipulating this coordinate proves to be relatively difficult.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This post is to be the first in a series of my struggles coming from an atmospheric science background and transitioning into software. My hope is that if I detail pain points and headaches I encounter along my journey, you won’t have to.</p>
<!-- TEASER_END -->
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="The-Task">The Task<a class="anchor-link" href="#The-Task">¶</a>
</h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Lately, I’ve been working on a project that compares modeled and measured data, which is pretty standard. The measured data is on a Gregorian calendar (meaning there are leap years), and the modeled data is on a 365-day no-leap calendar. This is a pretty standard occurrence, so there are tools available in pandas and xarray to help. But finding the correct steps across the many platforms that host documentation can be difficult -- so let me add one more platform: <em>this blog</em>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>First tip: You can find out the calendar your data is on using <code>xarray.dataset.time.encoding</code>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="The-Temptation">The Temptation<a class="anchor-link" href="#The-Temptation">¶</a>
</h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>At several moments I seriously considered writing my own functions to deal with date-time. When I talked to some of my friends (who are scientists) about it, they confessed to me that they had each written their own function for dealing with this. This is a problem. One of the tenants of the Pangeo community is making it so scientists aren’t all repeating the same work when encountering similar problems. I couldn’t write my own function for time, it was my job to demonstrate how to use the tools already approved by the Pangeo community. But it felt like all of the tools worked differently in different scenarios. I had to navigate the documentation to figure out the when and why of time.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="The-Tribulation">The Tribulation<a class="anchor-link" href="#The-Tribulation">¶</a>
</h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Essentially my data is in two distinct conventional ways of formatting time: <code>datetime64</code> and <code>cftime</code>. Both of these methods have different benefits.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>All of the data is initally in <code>float32</code> or <code>float64</code>, which xarray can automatically decode for me based on the time units and bounds supplied. If you did not want this to happen, then in <code>xarray.open_dataset()</code> specify the keyword argument <code>decode_cf=False</code>. <strong>In this case your time will be a series of float values that cannot be understood without your units</strong>, in this example (<code>"days since 1900-01-01 00:00:00"</code>):</p>

<pre><code>&lt;xarray.DataArray 'time' (time: 12784)&gt;
array([28854.75, 28855.75, 28856.75, ..., 41635.75, 41636.75, 41637.75],
      dtype=float32)
Coordinates:
  * time     (time) float32 28854.75 28855.75 28856.75 ... 41636.75 41637.75
Attributes:
    axis:           T
    standard_name:  time
    long_name:      time
    calendar:       gregorian
    units:          days since 1900-01-01 00:00:00</code></pre>
<p><em>I have never specified this option and think decoding data according to CF conventions is typically preferred.</em></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>For the measured data, on a Gregorian calendar, time is converted to <strong><code>datetime64</code></strong> format which takes the following form:</p>

<pre><code>&lt;xarray.DataArray 'time' (time: 12784)&gt;
array(['1979-01-01T18:00:00.000000000', '1979-01-02T18:00:00.000000000',
       '1979-01-03T18:00:00.000000000', ..., '2013-12-29T18:00:00.000000000',
       '2013-12-30T18:00:00.000000000', '2013-12-31T18:00:00.000000000'],
      dtype='datetime64[ns]')
Coordinates:
  * time     (time) datetime64[ns] 1979-01-01T18:00:00 ... 2013-12-31T18:00:00</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><strong>The <code>datetime64</code> type does not yet have support for the no-leap calendar</strong>, and since the modeled data is on a no-leap calendar, time is returned in <strong><code>cftime.DatetimeNoLeap</code></strong>. This looks as follows:</p>

<pre><code>&lt;xarray.DataArray 'time' (time: 20440)&gt;
array([cftime.DatetimeNoLeap(1950, 1, 1, 12, 0, 0, 0, 4, 1),
       cftime.DatetimeNoLeap(1950, 1, 2, 12, 0, 0, 0, 5, 2),
       cftime.DatetimeNoLeap(1950, 1, 3, 12, 0, 0, 0, 6, 3), ...,
       cftime.DatetimeNoLeap(2005, 12, 29, 12, 0, 0, 0, 1, 363),
       cftime.DatetimeNoLeap(2005, 12, 30, 12, 0, 0, 0, 2, 364),
       cftime.DatetimeNoLeap(2005, 12, 31, 12, 0, 0, 0, 3, 365)], dtype=object)
Coordinates:
  * time     (time) object 1950-01-01 12:00:00 ... 2005-12-31 12:00:00</code></pre>
<p>So I need my data to be in the same format, but which one to pick?</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="The-Case-for-datetime64">The Case for datetime64<a class="anchor-link" href="#The-Case-for-datetime64">¶</a>
</h4>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Sometimes I want datetime. At one point I want to split my modeled dataset into two groups: an early piece that matches the time bounds from the measured data, and a future piece that includes all of the model yet to occur and to be bias-corrected. This is done with the <code>xarray.dataset.sel(time = slice(a, b))</code> where <code>a</code> and <code>b</code> are the first and last time point from the measured dataset as <code>yyy-mm-dd</code> which is <strong>in <code>datetime64</code> formatting!</strong></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="The-Case-for-cftime.DatetimeNoLeap">The Case for cftime.DatetimeNoLeap<a class="anchor-link" href="#The-Case-for-cftime.DatetimeNoLeap">¶</a>
</h4>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Converting a non-leap <code>cftime</code> variable to <code>datetime64</code> leads to <em>subtle errors</em>, which are avoided when I use <code>cftime</code> formatting.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Some of these errors occur in the <code>xarray.dataset.groupby('time.dayofyear')</code> functionality which I use to retrieve average values for each day of the year, across all years in the dataset. If I am in <code>datetime64</code> formatting, but with February 29th missing, this function spans 366 days for every year, instead of 365, and this error grows with every additional year of data (suddenly March 1st is averaged with March 2nd from the next year, for example). <strong>So I need my time coordinate to be in <code>cftime.DatetimeNoLeap</code> formatting.</strong></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="The-best-of-both-worlds">The best of both worlds<a class="anchor-link" href="#The-best-of-both-worlds">¶</a>
</h4>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The usual method for converting between <code>cftime</code> and <code>datetime64</code> is not supported for the non-standard 365 day no-leap calendar. The usual method being <code>pandas.to_datetime().</code></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>One workaround is to use <code>xarray.dataset.indexes[...].to_datetimeindex()</code>:</p>

<pre><code>datetimeindex = da.indexes['time'].to_datetimeindex()
da['time']= ('time', datetimeindex)</code></pre>
<p>Which always returns this warning (remember the subtle errors I mentioned):</p>

<pre><code>RuntimeWarning: Converting a CFTimeIndex with dates from a non-standard calendar, 'noleap', to a pandas.DatetimeIndex, which uses dates from the standard calendar.  This may lead to subtle errors in operations that depend on the length of time between dates.</code></pre>
<p>But if I want to be able to use both <code>cftime.DatetimeNoLeap</code> and <code>datetime64</code>, I had to write my own function to do this conversion:</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">cfnoleap_to_datetime</span><span class="p">(</span><span class="n">da</span><span class="p">):</span>
    <span class="n">datetimeindex</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">indexes</span><span class="p">[</span><span class="s1">'time'</span><span class="p">]</span><span class="o">.</span><span class="n">to_datetimeindex</span><span class="p">()</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">to_dataset</span><span class="p">()</span>
    <span class="n">ds</span><span class="p">[</span><span class="s1">'time_dt'</span><span class="p">]</span><span class="o">=</span> <span class="p">(</span><span class="s1">'time'</span><span class="p">,</span> <span class="n">datetimeindex</span><span class="p">)</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">swap_dims</span><span class="p">({</span><span class="s1">'time'</span><span class="p">:</span> <span class="s1">'time_dt'</span><span class="p">})</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">da</span><span class="o">.</span><span class="n">time</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">time_dt</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ds</span>
</pre></div>
<p>In order to maintain the information contained in <code>cftime</code> I need to upgrade my <code>DataArray</code> to a <code>Dataset</code>, then add a new dimension for the <code>datetime64</code> formatting of the time coordinate. Then I am able to simply use <code>xarray.dataset.swap_dims</code> to pick which formatting I want depending on the functionality I am using.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>I guess that wasn't that hard, but I couldn't find an example of this workflow anywhere. I hope sharing it here helps anyone with similar issues!</p>

</div>
</div>
</div>
</div></section></article><footer class="post-footer"><section class="comments hidden-print"><h2 style="padding-left: 3vw">Comments</h2>
        <script src="https://utteranc.es/client.js" repo="NCAR/xdev-blog-comments" issue-term="title" theme="github-light" crossorigin="anonymous" async>
        </script></section><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML" integrity="sha384-3lJUsx1TJHt7BA4udB5KPnDrlkO8T6J6v/op7ui0BbCjvZ9WqV4Xm6DTP6kQ/iBH" crossorigin="anonymous"></script><script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"] ],
        displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
        processEscapes: true
    },
    displayAlign: 'center', // Change this to 'left' if you want left-aligned equations.
    "HTML-CSS": {
        styles: {'.MathJax_Display': {"margin": 0}}
    }
});
</script></footer>
</div>
    </main><footer class="site-footer outer"><div class="site-footer-content inner">
        <div class="site-footer-image" style="width: 409px; height: 40px;">
          <a href="https://www2.cisl.ucar.edu/"><img src="../../assets/img/CISL-contemp-logo-white.svg" alt="CISL"></a>
        </div>
        <div class="site-footer-section">
          <section><a href="https://www.ucar.edu/">University Corporation for Atmospheric Research</a> © 2020<br>Proudly published with <a href="https://getnikola.com/">Nikola</a> &amp; <a href="https://pages.github.com/" target="_blank" rel="noopener">GitHub Pages</a><br>Apache 2.0</section>
</div>
      </div>
      <div class="site-footer-content inner" style="border: 0; padding: 0; flex-wrap: nowrap;">
        <div class="site-footer-image" style="width: 60px; height: 60px;">
          <a href="https://nsf.gov/"><img src="../../assets/img/footer-logo-nsf.png" alt="NSF"></a>
        </div>
        <div class="site-footer-section" style="width: 100%;">
          <section>This material is based upon work supported by the National Center for Atmospheric Research, a major facility sponsored by the National Science Foundation and managed by the University Corporation for Atmospheric Research. Any opinions, findings and conclusions or recommendations expressed in this material do not necessarily reflect the views of the National Science Foundation.</section>
</div>
      </div>
    </footer>
</div>
  
    <script type="text/javascript" src="../../assets/js/jquery.js"></script><script type="text/javascript" src="../../assets/js/jquery.fitvids.js"></script><script type="text/javascript" src="../../assets/js/index.js"></script>
</body>
</html>
